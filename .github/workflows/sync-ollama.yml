# .github/workflows/sync-ollama.yml

name: Sync DockerHub Ollama to GHCR

on:
  # 每天台北時間上午 10 點執行一次 (2 AM UTC)
  schedule:
    - cron: '0 2 * * *'
  
  # 允許手動從 Actions 頁面觸發此 workflow
  workflow_dispatch:

env:
  # 來源 Docker Hub 倉庫
  SOURCE_REPO: ollama/ollama
  # 目標 GHCR 倉庫 (請務必修改 YOUR_USERNAME)
  TARGET_REPO: ghcr.io/omygpt/ollama

jobs:
  sync:
    name: Sync Ollama Images
    runs-on: ubuntu-latest
    
    # 賦予 job 寫入 GitHub Packages (GHCR) 的權限
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up crane
        uses: imjasonh/setup-crane@v0.1

      - name: Login to Docker Hub
        # 登入 Docker Hub 以避免速率限制
        run: crane auth login -u ${{ secrets.DOCKERHUB_USERNAME }} -p ${{ secrets.DOCKERHUB_TOKEN }} docker.io

      - name: Login to GitHub Container Registry
        # 使用 GITHUB_TOKEN 自動登入 GHCR
        run: crane auth login -u ${{ github.actor }} -p ${{ secrets.GITHUB_TOKEN }} ghcr.io
        
      - name: Sync all tags from Docker Hub to GHCR
        run: |
          echo "Fetching tags from ${{ env.SOURCE_REPO }}..."
          # 取得來源倉庫的所有標籤
          tags=$(crane ls ${{ env.SOURCE_REPO }})
          
          echo "Starting sync to ${{ env.TARGET_REPO }}..."
          # 遍歷所有標籤並複製
          for tag in $tags; do
            echo "--> Syncing tag: $tag"
            crane copy "${{ env.SOURCE_REPO }}:$tag" "${{ env.TARGET_REPO }}:$tag"
          done
          
          echo "Sync completed!"
