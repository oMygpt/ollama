# .github/workflows/sync-images.yml

name: Sync Docker Images to GHCR and AliyunCR

on:
  # 每日排程觸發：設定於 UTC 時間 凌晨 2 點執行
  # 這對應到台灣/香港/北京時間 (CST, UTC+8) 的上午 10 點
  schedule:
    - cron: '0 2 * * *'
  
  # 手動觸發：允許您隨時從 GitHub 網站的 Actions 頁面手動執行
  workflow_dispatch:

jobs:
  sync-ollama:
    name: Sync Latest Stable Ollama Images
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    env:
      # 來源 Docker Hub 倉庫
      SOURCE_REPO: ollama/ollama
      # 目標 GHCR 倉庫 (請務必修改 YOUR_USERNAME 為您自己的 GitHub 使用者名稱，且必須為小寫)
      TARGET_REPO: ghcr.io/omygpt/ollama

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up crane
        uses: imjasonh/setup-crane@v0.1

      - name: Login to Docker Hub
        run: crane auth login -u ${{ secrets.DOCKERHUB_USERNAME }} -p ${{ secrets.DOCKERHUB_TOKEN }} docker.io
        
      - name: Login to GitHub Container Registry
        run: crane auth login -u ${{ github.actor }} -p ${{ secrets.GITHUB_TOKEN }} ghcr.io
        
      - name: Filter and Sync Latest Stable Tags for Ollama
        run: |
          echo "Fetching all tags from ${{ env.SOURCE_REPO }}..."
          
          # 1. 使用正規表示式 grep -E '^[0-9]+\.[0-9]+\.[0-9]+$' 精準過濾出純數字版本號 (X.Y.Z)
          #    這會自動排除所有包含 'rc', 'rocm', 'cuda' 等後綴的標籤
          # 2. 使用 sort -V 進行版本號排序
          # 3. 使用 tail -n 10 選取最新的 10 個穩定版
          stable_tags=$(crane ls ${{ env.SOURCE_REPO }} | grep -E '^[0-9]+\.[0-9]+\.[0-9]+$' | sort -V | tail -n 10)
          
          # 4. 為了確保 'latest' 標籤總是被同步，將它加入清單並去重
          final_tags=$(echo -e "${stable_tags}\nlatest" | sort -u)

          echo "The following stable tags for ollama will be synced:"
          echo "${final_tags}"
          
          echo "Starting sync to ${{ env.TARGET_REPO }}..."
          for tag in $final_tags; do
            echo "--> Syncing ollama tag: $tag"
            crane copy "${{ env.SOURCE_REPO }}:$tag" "${{ env.TARGET_REPO }}:$tag"
          done
          
          echo "Ollama sync completed!"

  sync-vllm:
    name: Sync Latest vllm-openai Image to Multi-Registry
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
      
    env:
      # 來源 Docker Hub 倉庫
      SOURCE_REPO: vllm/vllm-openai
      # 目標 GHCR 倉庫
      GHCR_TARGET_REPO: ghcr.io/omygpt/vllm-openai
      # 目標阿里雲倉庫
      ALIYUN_TARGET_REPO: registry.cn-hangzhou.aliyuncs.com/dslab/vllm

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up crane
        uses: imjasonh/setup-crane@v0.1

      - name: Login to Docker Hub
        run: crane auth login -u ${{ secrets.DOCKERHUB_USERNAME }} -p ${{ secrets.DOCKERHUB_TOKEN }} docker.io
        
      - name: Login to GitHub Container Registry
        run: crane auth login -u ${{ github.actor }} -p ${{ secrets.GITHUB_TOKEN }} ghcr.io
      
      # 新增步驟：登入阿里雲容器註冊表
      - name: Login to Aliyun Container Registry
        # 請確保您已在倉庫 Secrets 中設定 ALIYUN_USERNAME 和 ALIYUN_PASSWORD
        run: |
          echo "Attempting to log in with username: ${{ secrets.ALIYUN_USERNAME }}"
          crane auth login -u ${{ secrets.ALIYUN_USERNAME }} -p ${{ secrets.ALIYUN_PASSWORD }} registry.cn-hangzhou.aliyuncs.com
        
      - name: Sync Latest Tag for vllm-openai to multi-registry
        run: |
          TAG="latest"
          echo "Starting sync for ${{ env.SOURCE_REPO }}:$TAG to multiple registries..."
          
          # 1. 同步到 GHCR
          echo "--> Syncing to GHCR: ${{ env.GHCR_TARGET_REPO }}:$TAG"
          crane copy "${{ env.SOURCE_REPO }}:$TAG" "${{ env.GHCR_TARGET_REPO }}:$TAG"
          
          # 2. 同步到阿里雲 ACR
          echo "--> Syncing to Aliyun CR: ${{ env.ALIYUN_TARGET_REPO }}:$TAG"
          crane copy "${{ env.SOURCE_REPO }}:$TAG" "${{ env.ALIYUN_TARGET_REPO }}:$TAG"
          
          echo "vllm-openai multi-registry sync completed!"

