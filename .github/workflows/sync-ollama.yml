# .github/workflows/sync-ollama.yml

name: Sync Latest Stable Ollama Images to GHCR

on:
  # 每日排程觸發：設定於 UTC 時間 凌晨 2 點執行
  # 這對應到台灣/香港/北京時間 (CST, UTC+8) 的上午 10 點
  schedule:
    - cron: '0 2 * * *'
  
  # 手動觸發：允許您隨時從 GitHub 網站的 Actions 頁面手動執行
  workflow_dispatch:

# 環境變數，方便統一管理
env:
  # 來源 Docker Hub 倉庫
  SOURCE_REPO: ollama/ollama
  # 目標 GHCR 倉庫 (請務必修改 YOUR_USERNAME 為您自己的 GitHub 使用者名稱，且必須為小寫)
  TARGET_REPO: ghcr.io/omygpt/ollama

jobs:
  sync:
    name: Sync Latest Stable Ollama Images
    # 使用最新的 Ubuntu 虛擬環境
    runs-on: ubuntu-latest
    
    # 賦予 job 必要的權限
    permissions:
      contents: read      # 讀取 repo 內容 (例如 checkout)
      packages: write    # 寫入 GitHub Packages (GHCR)

    steps:
      # 步驟 1: 拉取 repo 程式碼
      - name: Checkout code
        uses: actions/checkout@v4

      # 步驟 2: 安裝 crane 工具
      - name: Set up crane
        uses: imjasonh/setup-crane@v0.1

      # 步驟 3: 登入 Docker Hub
      - name: Login to Docker Hub
        run: crane auth login -u ${{ secrets.DOCKERHUB_USERNAME }} -p ${{ secrets.DOCKERHUB_TOKEN }} docker.io
        
      # 步驟 4: 登入 GitHub Container Registry (GHCR)
      - name: Login to GitHub Container Registry
        run: crane auth login -u ${{ github.actor }} -p ${{ secrets.GITHUB_TOKEN }} ghcr.io
        
      # 步驟 5: 執行智能過濾與同步邏輯
      - name: Filter and Sync Latest Stable Tags
        run: |
          echo "Fetching all tags from ${{ env.SOURCE_REPO }}..."
          
          # 1. 使用正規表示式 grep -E '^[0-9]+\.[0-9]+\.[0-9]+$' 精準過濾出純數字版本號 (X.Y.Z)
          #    這會自動排除所有包含 'rc', 'rocm', 'cuda' 等後綴的標籤
          # 2. 使用 sort -V 進行版本號排序
          # 3. 使用 tail -n 10 選取最新的 10 個穩定版
          stable_tags=$(crane ls ${{ env.SOURCE_REPO }} | grep -E '^[0-9]+\.[0-9]+\.[0-9]+$' | sort -V | tail -n 10)
          
          # 4. 為了確保 'latest' 標籤總是被同步，將它加入清單並去重
          final_tags=$(echo -e "${stable_tags}\nlatest" | sort -u)

          echo "The following stable tags will be synced:"
          echo "${final_tags}"
          
          echo "Starting sync to ${{ env.TARGET_REPO }}..."
          for tag in $final_tags; do
            echo "--> Syncing tag: $tag"
            crane copy "${{ env.SOURCE_REPO }}:$tag" "${{ env.TARGET_REPO }}:$tag"
          done
          
          echo "Sync completed!"
