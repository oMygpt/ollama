# .github/workflows/sync-images.yml
name: Sync Docker Images to GHCR and AliyunCR
on:
  # æ¯æ—¥æ’ç¨‹è§¸ç™¼ï¼šè¨­å®šæ–¼ UTC æ™‚é–“ å‡Œæ™¨ 2 é»åŸ·è¡Œ
  # é€™å°æ‡‰åˆ°å°ç£/é¦™æ¸¯/åŒ—äº¬æ™‚é–“ (CST, UTC+8) çš„ä¸Šåˆ 10 é»
  schedule:
    - cron: '0 2 * * *'  # ä¿®æ­£ cron è¡¨è¾¾å¼
  
  # æ‰‹å‹•è§¸ç™¼ï¼šå…è¨±æ‚¨éš¨æ™‚å¾ GitHub ç¶²ç«™çš„ Actions é é¢æ‰‹å‹•åŸ·è¡Œ
  workflow_dispatch:

jobs:
  sync-ollama:
    name: Sync Latest Stable Ollama Images
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    env:
      # ä¾†æº Docker Hub å€‰åº«
      SOURCE_REPO: ollama/ollama
      # ç›®æ¨™ GHCR å€‰åº« (è«‹å‹™å¿…ä¿®æ”¹ YOUR_USERNAME ç‚ºæ‚¨è‡ªå·±çš„ GitHub ä½¿ç”¨è€…åç¨±ï¼Œä¸”å¿…é ˆç‚ºå°å¯«)
      TARGET_REPO: ghcr.io/omygpt/ollama
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Set up crane
        uses: imjasonh/setup-crane@v0.1
      - name: Login to Docker Hub
        run: crane auth login -u ${{ secrets.DOCKERHUB_USERNAME }} -p ${{ secrets.DOCKERHUB_TOKEN }} docker.io
        
      - name: Login to GitHub Container Registry
        run: crane auth login -u ${{ github.actor }} -p ${{ secrets.GITHUB_TOKEN }} ghcr.io
        
      - name: Filter and Sync Latest Stable Tags for Ollama
        run: |
          echo "Fetching all tags from ${{ env.SOURCE_REPO }}..."
          
          # 1. ä½¿ç”¨æ­£è¦è¡¨ç¤ºå¼ grep -E '^[0-9]+\.[0-9]+\.[0-9]+$' ç²¾æº–éæ¿¾å‡ºç´”æ•¸å­—ç‰ˆæœ¬è™Ÿ (X.Y.Z)
          #    é€™æœƒè‡ªå‹•æ’é™¤æ‰€æœ‰åŒ…å« 'rc', 'rocm', 'cuda' ç­‰å¾Œç¶´çš„æ¨™ç±¤
          # 2. ä½¿ç”¨ sort -V é€²è¡Œç‰ˆæœ¬è™Ÿæ’åº
          # 3. ä½¿ç”¨ tail -n 10 é¸å–æœ€æ–°çš„ 10 å€‹ç©©å®šç‰ˆ
          stable_tags=$(crane ls ${{ env.SOURCE_REPO }} | grep -E '^[0-9]+\.[0-9]+\.[0-9]+$' | sort -V | tail -n 10)
          
          # 4. ç‚ºäº†ç¢ºä¿ 'latest' æ¨™ç±¤ç¸½æ˜¯è¢«åŒæ­¥ï¼Œå°‡å®ƒåŠ å…¥æ¸…å–®ä¸¦å»é‡
          final_tags=$(echo -e "${stable_tags}\nlatest" | sort -u)
          echo "The following stable tags for ollama will be synced:"
          echo "${final_tags}"
          
          echo "Starting sync to ${{ env.TARGET_REPO }}..."
          for tag in $final_tags; do
            echo "--> Syncing ollama tag: $tag"
            crane copy "${{ env.SOURCE_REPO }}:$tag" "${{ env.TARGET_REPO }}:$tag"
          done
          
          echo "Ollama sync completed!"

  sync-vllm:
    name: Sync Latest vllm-openai Image to Multi-Registry
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
      
    env:
      # ä¾†æº Docker Hub å€‰åº«
      SOURCE_REPO: vllm/vllm-openai
      # ç›®æ¨™ GHCR å€‰åº«
      GHCR_TARGET_REPO: ghcr.io/omygpt/vllm-openai
      # ç›®æ¨™é˜¿é‡Œé›²å€‰åº«
      ALIYUN_TARGET_REPO: registry.cn-hangzhou.aliyuncs.com/dslab/vllm
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Set up crane
        uses: imjasonh/setup-crane@v0.1
      - name: Login to Docker Hub
        run: crane auth login -u ${{ secrets.DOCKERHUB_USERNAME }} -p ${{ secrets.DOCKERHUB_TOKEN }} docker.io
        
      - name: Login to GitHub Container Registry
        run: crane auth login -u ${{ github.actor }} -p ${{ secrets.GITHUB_TOKEN }} ghcr.io
      
      # ä¿®æ­£é˜¿é‡Œé›²ç™»å…¥æ­¥é©Ÿ
      - name: Login to Aliyun Container Registry
        run: |
          echo "Logging in to Aliyun Container Registry..."
          # å¢åŠ è°ƒè¯•ä¿¡æ¯ï¼Œä½†ä¸æ˜¾ç¤ºå®Œæ•´ç”¨æˆ·åï¼ˆå®‰å…¨è€ƒè™‘ï¼‰
          echo "Registry: registry.cn-hangzhou.aliyuncs.com"
          echo "Namespace: dslab"
          
          # å°è¯•ç™»å½•ï¼Œå¢åŠ é”™è¯¯å¤„ç†
          if ! crane auth login -u "${{ secrets.ALIYUN_USERNAME }}" -p "${{ secrets.ALIYUN_PASSWORD }}" registry.cn-hangzhou.aliyuncs.com; then
            echo "Failed to login to Aliyun Container Registry"
            echo "Please check your ALIYUN_USERNAME and ALIYUN_PASSWORD secrets"
            echo "Username should be in format: namespace@é˜¿é‡Œäº‘è´¦å·ID or full access credential username"
            exit 1
          fi
          
          echo "Successfully logged in to Aliyun Container Registry"
        
      - name: Sync Latest Tag for vllm-openai to multi-registry
        run: |
          TAG="latest"
          echo "Starting sync for ${{ env.SOURCE_REPO }}:$TAG to multiple registries..."
          
          # 1. åŒæ­¥åˆ° GHCR
          echo "--> Syncing to GHCR: ${{ env.GHCR_TARGET_REPO }}:$TAG"
          if crane copy "${{ env.SOURCE_REPO }}:$TAG" "${{ env.GHCR_TARGET_REPO }}:$TAG"; then
            echo "âœ… GHCR sync completed successfully"
          else
            echo "âŒ GHCR sync failed"
            exit 1
          fi
          
          # 2. åŒæ­¥åˆ°é˜¿é‡Œé›² ACR (ä½¿ç”¨åˆ†æ­¥æ–¹å¼é¿å…è·¨ä»“åº“æŒ‚è½½é—®é¢˜)
          echo "--> Syncing to Aliyun CR: ${{ env.ALIYUN_TARGET_REPO }}:$TAG"
          
          # æ–¹æ³•1: å°è¯•ç›´æ¥å¤åˆ¶
          echo "Attempting direct copy..."
          if crane copy "${{ env.SOURCE_REPO }}:$TAG" "${{ env.ALIYUN_TARGET_REPO }}:$TAG" 2>&1 | tee copy_log.txt; then
            echo "âœ… Aliyun CR direct copy completed successfully"
          else
            echo "Direct copy failed, trying alternative method..."
            
            # æ–¹æ³•2: é€šè¿‡æœ¬åœ°ç¼“å­˜æ–¹å¼
            echo "Pulling image locally first..."
            if crane pull "${{ env.SOURCE_REPO }}:$TAG" /tmp/image.tar; then
              echo "Pushing to Aliyun CR from local cache..."
              if crane push /tmp/image.tar "${{ env.ALIYUN_TARGET_REPO }}:$TAG"; then
                echo "âœ… Aliyun CR sync completed via local cache"
              else
                echo "âŒ Both methods failed for Aliyun CR sync"
                cat copy_log.txt || true
                exit 1
              fi
            else
              echo "âŒ Failed to pull image locally"
              exit 1
            fi
          fi
          
          echo "ğŸ‰ vllm-openai multi-registry sync completed!"
